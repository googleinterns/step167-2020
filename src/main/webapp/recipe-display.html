<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melting Pot</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div id="recipe"></div>
    <!-- Comment submission form -->
    <div>
      <label for="comment-content" id="comment-label">Message</label><br />
      <input type="text" id="comment-content" name="comment-content" placeholder="Leave a comment..." />
      <br />
      <button type="button" id="submit-comment" value="Submit">Submit</button>
    </div>
    <div id="comments"></div>
    <button type="button" id="delete-post">Delete Post</button>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>
    
    <!-- Page scripts -->
    <script type="module">
      import { app } from "/scripts/init.js"

      var deletePostButton = document.getElementById("delete-post")
      var submitCommButton = document.getElementById("submit-comment")
      var commentLabel = document.getElementById("comment-label")
      var commentContent = document.getElementById("comment-content")

      /** On window load, initialize the page. */
      window.onload = function () {
        initPage()
      }

      /** Load page elements. */
      function initPage() {
        
        // Load the recipe and comments on the page.
        getDetailedRecipe(getRecipeID())
        getComments(getRecipeID())

        // Set button click listeners.
        deletePostButton.addEventListener("click", deletePost)
        submitCommButton.addEventListener("click", submitComment)

        // Hide buttons and comment input for non signed-in user.
        toggleElementVisibility(app.auth().currentUser)

        // Set auth state change listener.
        // Currently toggles visibility only.
        app.auth().onAuthStateChanged(function (user){
          toggleElementVisibility(user)
        })
      }
      
      function toggleElementVisibility(isVisible) {
        if (app == null) {
          return
        }
        var elements = [deletePostButton, submitCommButton, commentLabel, commentContent]
        for (var el of elements) {
          el.hidden = !isVisible
        }
      }

      /** Returns the recipe ID in the query string for this page. */
      function getRecipeID() {
        const params = new URLSearchParams(window.location.search)
        return params.get("recipeID")
      }

      /** Submit a comment -- disallow if no user is signed into the webapp. */
      function submitComment() {
        var commentContent = document.getElementById("comment-content")
        var recipeID = getRecipeID()

        if (app.auth().currentUser) {
          app
            .auth()
            .currentUser.getIdToken(/* forceRefresh */ true)
            .then(function (idToken) {
              fetch("/api/comment?recipeID=" + recipeID + "&token=" + idToken, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  content: commentContent.value,
                }),
              }).then((response) => {
                if (response.status >= 200 && response.status < 300) {
                  getComments(recipeID)
                } else {
                  alert("Error " + response.status.toString())
                }
              })
            })
            .catch(function (error) {
              alert("Error! Could not retrieve user ID token.")
            })
        } else {
          alert("User must be signed in to submit a comment.")
        }
      }

      /** Adds comments associated with a recipe to the UI. */
      function getComments(recipeID) {
        fetch("api/comment?recipeID=" + recipeID)
          .then(() => fetch("api/comment?recipeID=" + recipeID))
          .then((response) => response.json())
          .then((comments) => {
            const commentEl = document.getElementById("comments")
            commentEl.innerHTML = ""
            comments.forEach((comment) => {
              commentEl.appendChild(createCommentElement(comment))
            })
          })
      }

      function getDetailedRecipe(ID) {
        fetch("/api/post?recipeID=" + ID)
          .then((response) => response.json())
          .then((recipe) => {
            const recipeEl = document.getElementById("recipe")
            removeAllChildNodes(recipeEl)
            recipeEl.appendChild(createRecipeListElement(recipe))
          })
      }

      function deletePost() {
        var recipeID = getRecipeID()
        
        fetch("/api/post?recipeID=" + recipeID, {
          method: "DELETE",
        }).then((response) => {
          if (response.status >= 200 && response.status < 300) {
            window.location.href = "/feed.html"
          } else {
            alert("Error " + response.status.toString())
          }
        })
      }

      function removeAllChildNodes(parent) {
        while (parent.firstChild) {
          parent.removeChild(parent.firstChild)
        }
      }

      function createCommentElement(comment) {
        const commentEl = document.createElement("div")
        commentEl.appendChild(createBasicElement(comment.content, "p"))
        commentEl.appendChild(document.createElement("hr"))
        return commentEl
      }

      function createRecipeListElement(recipe) {
        const recipeElement = document.createElement("div")
        recipeElement.appendChild(createBasicElement(recipe.title, "h2"))
        recipeElement.appendChild(createBasicElement(recipe.content, "p"))
        return recipeElement
      }

      function createBasicElement(text, type) {
        const basicElement = document.createElement(type)
        if (text != "") basicElement.innerHTML = marked(text)
        return basicElement
      }
    </script>
  </body>
</html>
