<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melting Pot</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>

    <!-- Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <h1>
      Recipes
    </h1>
    <br />
    <a href="/submit-recipe.html">Add your own recipe!</a>
    <br />

    <p>Select filters:</p>
    <select onchange="addFilter()" id="tag-select">
      <option>None</option>
    </select>

    <p>Currently selected filters:</p>
    <div id="selected-filters"></div>
    <br />

    <ul id="recipe-list"></ul>

    <script>
      let recipeList = document.getElementById("recipe-list")
      fetch("/api/post").then(async (response) => {
        if (response.status < 200 || response.status >= 300) {
          alert("Error " + response.status.toString())
        } else {
          let recipes = await response.json()
          recipes.forEach((recipe) => {
            recipeList.innerHTML +=
              '<li><a href="recipe-display.html?recipeID=' + recipe.id + '">' + recipe.title + "</a></li>"
          })
        }
      })

      let tagSelect = document.getElementById("tag-select")
      fetch("/api/tag").then(async (response) => {
        if (response.status < 200 || response.status >= 300) {
          alert("Error " + response.status.toString())
        } else {
          let tags = await response.json()
          tags.forEach((tag) => {
            tagSelect.innerHTML += '<option value="' + tag.id + '">' + tag.name + "</option>"
          })
        }
      })

      function getRecipes() {
         // This returns our new tagID, used in next commit
        const tagIDs = getCurrentFilters()
        let recipeList = document.getElementById("recipe-list")
        fetch("/api/post?tagIDs=" + tagIDs).then(async (response) => {
          if (response.status < 200 || response.status >= 300) {
            alert("Error " + response.status.toString())
          } else {
            let recipes = await response.json()
            recipeList.innerHTML = ""
            recipes.forEach((recipe) => {
              recipeList.innerHTML +=
                '<li><a href="recipe-display.html?recipeID=' + recipe.id + '">' + recipe.title + "</a></li>"
            })
          }
        })
      }

      function getCurrentFilters() {
        var filterString = ""
        var filters = document.getElementById("selected-filters").childNodes
        if (filters.length < 1) {
          return "None"
        }
        filterString += filters[0].id
        for (var x = 1; x < filters.length; x++) {
          filterString += "," + filters[x].id
        }
        return filterString
      }

      function addFilter() {
        const tagID = tagSelect.value
        if (tagID == "None" || tagInFilters(tagID)) {
          return
        }
        let filterList = document.getElementById("selected-filters")
        const filter = document.createElement("DIV")
        filter.innerText = getOptionByValue(tagID).innerText
        filter.id = tagID
        filterList.appendChild(filter)
        filter.addEventListener("click", function (e) {
          filter.parentNode.removeChild(filter)
          getRecipes()
        })
        getRecipes()
      }

      function tagInFilters(tagID) {
        var filters = document.getElementById("selected-filters").childNodes
        for (var x = 0; x < filters.length; x++) {
          if (filters[x].id == tagID)
            return true
        }
        return false
      }

      function getOptionByValue(value) {
        var allOptions = document.getElementsByTagName("option")
        var results = []
        for (var x = 0; x < allOptions.length; x++) if (allOptions[x].value == value) { 
            results.push(allOptions[x])
        }
        return results[0]
      }
    </script>
  </body>
</html>
