<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melting Pot</title>
    <link rel="stylesheet" href="style.css" />
    <script type="module" src="/scripts/init.js"></script>
  </head>
  <body>
    <!-- Page content -->
    <h1>
      Recipes
    </h1>
    <br />
    <a href="/submit-recipe.html">Add your own recipe!</a>
    <br />

    <p>Select filters:</p>
    <select id="tag-select">
      <option>None</option>
    </select>

    <p>Currently selected filters:</p>
    <div id="selected-filters"></div>
    <br />

    <div class="btn-group" id="display-type-select">
      <div id="list-btn"><button type="button">List</button></div>
      <div id="map-btn"><button type="button">Map</button></div>
    </div>

    <ul id="recipe-list"></ul>
    <div id="map"></div>

    <style>
      #map {
        height: 300px;
        width: 600px;
      }
    </style>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>

    <!-- Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAe5HlFZFuhzMimXrKW1z3kglajbdHf_Rc"></script>

    <!-- Page scripts -->
    <script type="module">
      import { app } from "/scripts/init.js"

      let map
      let markers = []
      let recipeList = document.getElementById("recipe-list")
      let tagSelect = document.getElementById("tag-select")

      window.addFilter = addFilter

      /** On window load, initialize the page. */
      window.onload = function () {
        initPage()
      }

      function showList() {
        document.getElementById("recipe-list").style.display = "block"
        document.getElementById("map").style.display = "none"
      }

      function showMap() {
        document.getElementById("map").style.display = "block"
        document.getElementById("recipe-list").style.display = "none"
      }

      /** Load page elements. */
      function initPage() {
        // Set event listeners.
        document.getElementById("tag-select").addEventListener("change", addFilter)
        document.getElementById("list-btn").addEventListener("click", showList)
        document.getElementById("map-btn").addEventListener("click", showMap)

        // Initialize tag-select
        loadTags()

        getRecipes()
        createMap()
        showList()
      }

      function loadTags() {
        // Fetch all recipe tags to populate our select form
        fetch("/api/tag").then(async (response) => {
          if (!response.ok) {
            alert("Error " + response.status.toString())
          } else {
            let tags = await response.json()
            tags.forEach((tag) => {
              tagSelect.innerHTML += '<option value="' + tag.id + '">' + tag.name + "</option>"
            })
          }
        })
      }

      // Performs retrieval of recipes based on the filters currently contained in <div> 'selected-filters'
      function getRecipes() {
        const tagIDs = getCurrentFilters()
        let recipeList = document.getElementById("recipe-list")
        let queryString = "/api/post"

        let tagsQuery = tagIDs.map((id) => "tagIDs=" + id)
        queryString += "?" + tagsQuery.join("&")

        console.log(queryString)

        fetch(queryString).then(async (response) => {
          if (!response.ok) {
            alert("Error " + response.status.toString())
          } else {
            let recipes = await response.json()
            recipeList.innerHTML = ""
            clearMarkers()
            recipes.forEach((recipe) => {
              recipeList.innerHTML +=
                '<li><a href="recipe-display.html?recipeID=' + recipe.id + '">' + recipe.title + "</a></li>"
              let marker = createMarkerAt(recipe.location, recipe.title)
              if (marker != null) {
                attachInfo(recipe, marker)
                markers.push(marker)
              }
            })
          }
        })
      }

      function createMap() {
        map = new google.maps.Map(document.getElementById("map"), { center: { lat: 20, lng: 0 }, zoom: 1 })
      }

      function getCurrentFilters() {
        var filters = Array.from(document.getElementById("selected-filters").childNodes)
        filters = filters.map((filter) => filter.id)
        return filters
      }

      function clearMarkers() {
        markers.forEach((marker) => {
          if (marker != null) {
            marker.setMap(null)
          }
        })
        markers = []
      }

      function createMarkerAt(location, title) {
        let marker = null
        if (location != null && location != undefined) {
          marker = new google.maps.Marker({
            position: new google.maps.LatLng(location.latitude, location.longitude),
            map: map,
            title: title,
          })
        }
        return marker
      }

      function attachInfo(recipe, marker) {
        // prettier-ignore
        let contentString =
          '<div id="content">' + 
            '<div id="siteNotice"></div>' +
            '<h1 id="firstHeading" class="firstHeading">' +
              '<a href="recipe-display.html?recipeID=' + recipe.id + '">' + recipe.title + "</a>" +
            "</h1>" +
            '<div id="bodyContent">' +
              "<p>Posted by: " + recipe.creatorLdap + "</p>" +
              "<p>Votes: " + recipe.votes + "</p>" +
            "</div>" +
          "</div>"

        let infowindow = new google.maps.InfoWindow({
          content: contentString,
        })

        marker.addListener("click", function () {
          infowindow.open(map, marker)
        })
      }

      // Adds a filter to list of selected-filters
      function addFilter() {
        const tagID = tagSelect.value
        if (tagID == "None" || tagInFilters(tagID)) {
          return
        }
        let filterList = document.getElementById("selected-filters")

        // Create 'filter' element with id matching tag ID and innertext matching tag name
        const filter = document.createElement("DIV")
        // Retrieve option with matching tagID then retrieve innertext (tag name)
        filter.innerText = getOptionByValue(tagID).innerText
        filter.id = tagID

        filterList.appendChild(filter)
        filter.addEventListener("click", function (e) {
          // When we click a currently selected filter, remove it and retrieve recipes
          filter.parentNode.removeChild(filter)
          getRecipes()
        })
        getRecipes()
      }

      // Determines if the passed tagID is represented in the current selected filters
      function tagInFilters(tagID) {
        var filters = document.getElementById("selected-filters").childNodes
        for (var x = 0; x < filters.length; x++) {
          if (filters[x].id == tagID) return true
        }
        return false
      }

      // Returns the first option whose 'value' property (ie the id of the tag it represents)
      // matches value
      function getOptionByValue(value) {
        var allOptions = document.getElementsByTagName("option")
        var results = []
        for (var x = 0; x < allOptions.length; x++) {
          if (allOptions[x].value == value) {
            results.push(allOptions[x])
          }
        }
        return results[0]
      }
    </script>
  </body>
</html>
