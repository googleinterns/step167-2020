<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melting Pot</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <!-- Recipe form -->
    <div>
      <label for="recipe-title">Recipe Title</label><br />
      <input type="text" id="recipe-title" name="recipe-title" placeholder="e.g. Grandma's Zucchini Florentine" />
      <br />
      <label for="instructions">Recipe Instructions</label><br />
      <textarea
        rows="10"
        cols="70"
        name="instructions"
        id="instructions"
        placeholder="e.g. Preheat the oven to 350 degrees."
      ></textarea>
      <br />
      <div id="recipe-preview">
        <h1 id="title-preview"></h1>
        <div id="instructions-preview"></div>
      </div>
      <br />
      <p>Where does this recipe come from?</p>
      <div id="map"></div>
      <p id="location-display">Location selected:</p>
      <br />
      <p>Add tags to your recipe:</p>
      <select id="tag-select">
        <option>None</option>
      </select>
      <p>Currently selected tags:</p>
      <div id="selected-tags"></div>
      <br />
      <button type="button" id="submit" value="Submit">Submit</button>
    </div>

    <style>
      #map {
        height: 400px;
        width: 800px;
      }
    </style>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAe5HlFZFuhzMimXrKW1z3kglajbdHf_Rc"></script>

    <script type="module">
      import { app } from "/scripts/init.js"

      let map
      let geocoder
      let region
      let marker = null
      let tagSelect = document.getElementById("tag-select")

      /** On window load, initialize the page. */
      window.onload = function () {
        initPage()
      }

      /** Load page elements. */
      function initPage() {
        // Set event listeners.
        document.getElementById("submit").addEventListener("click", submitRecipe)
        document.querySelector("input").addEventListener("input", renderRecipe)
        document.querySelector("textarea").addEventListener("input", renderRecipe)
        document.getElementById("tag-select").addEventListener("change", addTag)

        // Initialize tag-select
        loadTags()

        createMap()
      }

      // Fetch all recipe tags to populate our select form
      function loadTags() {
        fetch("/api/tag").then(async (response) => {
          if (!response.ok) {
            alert("Error " + response.status.toString())
          } else {
            let tags = await response.json()
            tags.forEach((tag) => {
              tagSelect.innerHTML += '<option value="' + tag.id + '">' + tag.name + "</option>"
            })
          }
        })
      }

      function createMap() {
        map = new google.maps.Map(document.getElementById("map"), { center: { lat: 20, lng: 0 }, zoom: 1 })
        geocoder = new google.maps.Geocoder()

        google.maps.event.addListener(map, "click", function (event) {
          placeMarker(event.latLng)
          displayCountry(event.latLng)
          console.log("Location: " + event.latLng)
        })
      }

      function placeMarker(location) {
        if (marker != null) {
          marker.setMap(null)
        }
        marker = new google.maps.Marker({ position: location, map: map })
        marker.addListener("click", function (e) {
          marker.setMap(null)
          document.getElementById("location-display").innerText = "Location selected:"
        })
      }

      function displayCountry(location) {
        map.setZoom(4)
        map.panTo(location)

        region = ""
        geocoder.geocode({ location: location }, function (results, status) {
          if (status === "OK") {
            if (results[0]) {
              results[0].address_components.forEach((component) => {
                if (
                  component.types.includes("country") ||
                  (component.types.includes("natural_feature") && region == "")
                ) {
                  region = component.long_name
                }
              })
            } else {
              window.alert("No results found")
            }
          } else {
            window.alert("Geocoder failed due to: " + status)
          }
          document.getElementById("location-display").innerText = "Location selected: " + region
        })
      }

      /** Display the recipe being typed in markdown with formatting, in real-time. */
      function renderRecipe() {
        let titleInput = document.getElementById("recipe-title")
        let instructionsInput = document.getElementById("instructions")
        let titlePreview = document.getElementById("title-preview")
        let instructionsPreview = document.getElementById("instructions-preview")

        titlePreview.innerText = titleInput.value
        instructionsPreview.innerHTML = marked(instructions.value)
      }

      /** Submit a recipe-- disallow if no user is signed into webapp. */
      function submitRecipe() {
        let titleInput = document.getElementById("recipe-title")
        let instructionsInput = document.getElementById("instructions")
        let tags = getCurrentTags()

        // Make sure a user is signed in before posting.
        if (app.auth().currentUser) {
          app
            .auth()
            .currentUser.getIdToken(/* forceRefresh */ true)
            .then(function (idToken) {
              // Send token to backend via HTTPS
              fetch("/api/post?token=" + idToken, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  metadata: {
                    title: titleInput.value,
                    tagIds: tags,
                    region: region,
                    location: { latitude: marker.getPosition().lat(), longitude: marker.getPosition().lng() },
                  },
                  content: instructionsInput.value,
                }),
              }).then((response) => {
                if (!response.ok) {
                  alert("Error " + response.status.toString())
                  return
                }
                response.json().then((data) => (window.location.href = "/recipe-display.html?recipeID=" + data.id))
              })
            })
            .catch(function (error) {
              alert("Error! Could not retrieve user ID token.")
            })
        } else {
          alert("User must be signed in to submit a recipe.")
        }
      }

      // Returns the current set of tags as a Map<String, Boolean>
      function getCurrentTags() {
        let tagMap = {}
        let tagList = Array.from(document.getElementById("selected-tags").childNodes)
        tagList.forEach((tag) => {
          tagMap[tag.id] = true
        })
        return tagMap
      }

      // Adds a tag to list of selected-tags
      function addTag() {
        const tagID = tagSelect.value
        if (tagID == "None" || tagSelected(tagID)) {
          return
        }
        let tagList = document.getElementById("selected-tags")

        // Create 'tag' element with id matching tag ID and innertext matching tag name
        const tag = document.createElement("DIV")
        // Retrieve option with matching tagID then retrieve innertext (tag name)
        tag.innerText = getOptionByValue(tagID).innerText
        tag.id = tagID

        tagList.appendChild(tag)
        tag.addEventListener("click", function (e) {
          // When we click a currently selected tag, remove it and retrieve recipes
          tag.parentNode.removeChild(tag)
        })
      }

      // Determines if the passed tagID is represented in the current selected tags
      function tagSelected(tagID) {
        var selectedTags = document.getElementById("selected-tags").childNodes
        for (var x = 0; x < selectedTags.length; x++) {
          if (selectedTags[x].id == tagID) return true
        }
        return false
      }

      // Returns the first option whose 'value' property (ie the id of the tag it represents)
      // matches value
      function getOptionByValue(value) {
        var allOptions = document.getElementsByTagName("option")
        var results = []
        for (var x = 0; x < allOptions.length; x++) {
          if (allOptions[x].value == value) {
            results.push(allOptions[x])
          }
        }
        return results[0]
      }
    </script>
  </body>
</html>
