<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melting Pot</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <!-- Recipe form -->
    <div>
      <label for="recipe-title">Recipe Title</label><br />
      <input type="text" id="recipe-title" name="recipe-title" placeholder="e.g. Grandma's Zucchini Florentine" />
      <br />
      <label for="instructions">Recipe Instructions</label><br />
      <textarea
        rows="10"
        cols="70"
        name="instructions"
        id="instructions"
        placeholder="e.g. Preheat the oven to 350 degrees."
      ></textarea>
      <br />
      <button type="button" id="submit" value="Submit">Submit</button>
    </div>
    <div id="recipe-preview">
      <h1 id="title-preview"></h1>
      <div id="instructions-preview"></div>
    </div>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>

    <script type="module">
      import { app } from "/scripts/init.js"

      /** On window load, initialize the page. */
      window.onload = function () {
        initPage()
      }

      /** Load page elements. */
      function initPage() {
        // Set event listeners.
        document.getElementById("submit").addEventListener("click", submitRecipe)
        document.querySelector("input").addEventListener("input", renderRecipe)
        document.querySelector("textarea").addEventListener("input", renderRecipe)
      }

      /** Display the recipe being typed in markdown with formatting, in real-time. */
      function renderRecipe() {
        let titleInput = document.getElementById("recipe-title")
        let instructionsInput = document.getElementById("instructions")
        let titlePreview = document.getElementById("title-preview")
        let instructionsPreview = document.getElementById("instructions-preview")

        titlePreview.innerText = titleInput.value
        instructionsPreview.innerHTML = marked(instructions.value)
      }

      /** Submit a recipe-- disallow if no user is signed into webapp. */
      function submitRecipe() {
        let titleInput = document.getElementById("recipe-title")
        let instructionsInput = document.getElementById("instructions")

        // Make sure a user is signed in before posting.
        if (app.auth().currentUser) {
          app
            .auth()
            .currentUser.getIdToken(/* forceRefresh */ true)
            .then(function (idToken) {
              // Send token to backend via HTTPS
              fetch("/api/post?token=" + idToken, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  metadata: { title: titleInput.value },
                  content: instructionsInput.value,
                }),
              }).then((response) => {
                if (!response.ok) {
                  alert("Error " + response.status.toString())
                  return
                }
                response.json().then((data) => (window.location.href = "/recipe-display.html?recipeID=" + data.id))
              })
            })
            .catch(function (error) {
              alert("Error! Could not retrieve user ID token.")
            })
        } else {
          alert("User must be signed in to submit a recipe.")
        }
      }
    </script>
  </body>
</html>
